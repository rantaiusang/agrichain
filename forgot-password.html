<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lupa Kata Sandi - AgriChain</title>
    
    <!-- Config & SDK -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary-green: #2E7D32; --primary-dark: #1B5E20; --bg-color: #F1F8E9; --text-dark: #333; --white: #ffffff; --error: #D32F2F; --border: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; color: var(--text-dark); }
        .forgot-card { background: var(--white); width: 100%; max-width: 400px; padding: 2.5rem 2rem; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; }
        .logo { color: var(--primary-green); font-size: 2rem; margin-bottom: 1rem; font-weight: 800; }
        .subtitle { color: #666; font-size: 0.95rem; margin-bottom: 2rem; line-height: 1.5; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; margin-bottom: 0.6rem; font-size: 0.85rem; font-weight: 700; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; transition: all 0.3s ease; }
        .form-input:focus { border-color: var(--primary-green); outline: none; box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1); }
        .btn-submit { width: 100%; padding: 16px; background-color: var(--primary-green); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 2rem; transition: all 0.2s; }
        .btn-submit:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-submit:disabled { background-color: #81C784; cursor: not-allowed; transform: none; }
        .back-link { display: inline-block; margin-top: 2rem; color: var(--primary-green); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
        .back-link:hover { text-decoration: underline; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; margin-right: 8px; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="forgot-card">
        <div class="logo">üîë AgriChain</div>
        <div class="subtitle">Lupa kata sandi Anda? Kami akan mengirimkan link reset ke email Anda.</div>

        <form id="forgotForm" autocomplete="off">
            <div class="form-group">
                <label for="email">Alamat Email</label>
                <input type="email" id="email" class="form-input" placeholder="nama@email.com" required>
            </div>

            <button type="submit" id="btnSubmit" class="btn-submit">
                <span class="spinner" id="spinner"></span>
                <span id="btnText">KIRIM LINK RESET</span>
            </button>
        </form>

        <a href="login.html" class="back-link">‚Üê Kembali ke Login</a>
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // 1. CEK CONFIG
        if (typeof window.appConfig === 'undefined') {
            console.error("FATAL: config.js tidak dimuat.");
            alert("Konfigurasi sistem hilang.");
            throw new Error("Config Missing");
        }

        const { supabase } = window;
        const supabaseClient = supabase.createClient(window.appConfig.supabaseUrl, window.appConfig.supabaseKey);

        // 2. DOM ELEMENTS
        const form = document.getElementById('forgotForm');
        const emailInput = document.getElementById('email');
        const btnSubmit = document.getElementById('btnSubmit');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');

        // 3. LOGIKA RESET
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = emailInput.value.trim();

            if(!email) {
                alert("Mohon isi alamat email.");
                return;
            }

            // UI Loading
            btnSubmit.disabled = true;
            btnSubmit.classList.add('btn-submit:disabled');
            btnText.textContent = 'MEMPROSES...';
            spinner.style.display = 'inline-block';

            try {
                console.log(`[System] Mengirim reset password untuk: ${email}`);

                // Supabase Function: Mengirim Magic Link ke email
                const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email);

                if (error) throw error;

                console.log("[System] Sukses kirim reset.");
                alert(`Link reset password telah dikirim ke ${email}. \n\nSilakan cek Inbox atau Spam folder Kamu, lalu klik link tersebut untuk membuat password baru.`);

            } catch (err) {
                console.error("[System] Error:", err);
                let msg = "Gagal mengirim link.";
                
                if (err.message.includes('Email not confirmed')) {
                    msg = "Email belum dikonfirmasi. Cek inbox.";
                } else if (err.message.includes('User not found')) {
                    msg = "Email ini tidak terdaftar di sistem.";
                } else if (err.message.includes('Security')) {
                    msg = "Fitur Magic Link belum dihidupkan di Supabase Dashboard.";
                }

                alert("Error: " + msg);
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.classList.remove('btn-submit:disabled');
                btnText.textContent = 'KIRIM LINK RESET';
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
