<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harga Pasar - AgriChain</title>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-green: #2E7D32;
            --light-green: #E8F5E9;
            --dark-green: #1B5E20;
            --text-dark: #333;
            --text-grey: #666;
            --white: #ffffff;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
            --radius: 8px;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        h2 { margin-top: 0; color: var(--primary-green); }
        h3 { margin-bottom: 15px; color: var(--text-dark); font-size: 1.2rem; }

        /* --- Harga Tabel --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: var(--light-green);
            color: var(--primary-green);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fafafa; }

        .price-up { color: #f44336; font-weight: bold; } /* Merah */
        .price-down { color: #2E7D32; font-weight: bold; } /* Hijau */

        /* --- REKOMENDASI --- */
        .recommendation-section {
            background: #fff3e0; /* Kuning Muda */
            border-left: 5px solid #ff9800;
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none; /* Disembunyikan sampai data termuat */
        }

        .rec-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .rec-buy { background: #E8F5E9; color: #2E7D32; }
        .rec-sell { background: #FFEBEE; color: #C62828; }
        .rec-hold { background: #F3E5F5; color: #333; }

        .rec-text { font-size: 1.1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 5px; }
        .rec-sub { font-size: 0.9rem; color: var(--text-grey); }

        /* --- TREND BAR CHART --- */
        .trend-container { margin-top: 20px; }
        .trend-bar { margin-bottom: 15px; }
        .trend-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .trend-bg {
            width: 100%;
            background: #eee;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }
        .trend-fill {
            height: 100%;
            transition: width 1s ease-out;
        }
        .trend-up { background: #2E7D32; }
        .trend-down { background: #f44336; }

    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>ðŸ“Š Info Harga Pasar</h2>
            <a href="index.html" style="color: #666; text-decoration: none; font-weight: bold;">&larr; Beranda</a>
        </div>

        <!-- Rekomendasi Algoritma -->
        <div class="recommendation-section" id="recCard">
            <span class="rec-badge" id="recBadge">ANALISIS</span>
            <div class="rec-text" id="recTitle">Analisa Harga...</div>
            <div class="rec-sub" id="recSubtitle">Sedang membandingkan dengan harga rata-rata pasar.</div>
        </div>

        <!-- Tabel Harga -->
        <div class="card">
            <h3>Harga Komoditas Hari Ini</h3>
            <table>
                <thead>
                    <tr>
                        <th>Komoditas</th>
                        <th>Harga Hari Ini (Rp)</th>
                        <th>Persentase Perubahan</th>
                    </tr>
                </thead>
                <tbody id="hargaBody">
                    <tr>
                        <td colspan="3" style="text-align: center; color: #999;">Memuat data pasar...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Grafik Tren Sederhana -->
        <div class="card">
            <h3>Tren Harga (Grafik Batang)</h3>
            <div class="trend-container" id="trendChart">
                <!-- Grafik akan dirender JS -->
            </div>
        </div>

    </div>

    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://xyzcompany.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. DOM ELEMENTS ---
        const hargaBody = document.getElementById('hargaBody');
        const recCard = document.getElementById('recCard');
        const recBadge = document.getElementById('recBadge');
        const recTitle = document.getElementById('recTitle');
        const recSubtitle = document.getElementById('recSubtitle');
        const trendChart = document.getElementById('trendChart');

        // --- 3. LOAD DATA ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Cek Login (Opsional, tapi disarankan)
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                // Jika mau paksa login, uncomment baris bawah:
                // window.location.href = 'login.html'; 
                console.log("User belum login, tapi harga pasar bisa dilihat publik.");
            }

            // Ambil Data Harga dari Database
            const { data: prices, error } = await supabase
                .from('market_prices')
                .select('*')
                .order('current_price', { ascending: false });

            if (error) {
                console.error("Gagal ambil harga:", error);
                hargaBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Gagal memuat data.</td></tr>';
                return;
            }

            if (prices && prices.length > 0) {
                renderTable(prices);
                renderTrendChart(prices);
                analisaRekomendasi(prices);
            } else {
                hargaBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Belum ada data harga pasar.</td></tr>';
            }
        });

        // --- 4. RENDER TABEL ---
        function renderTable(prices) {
            hargaBody.innerHTML = '';
            
            prices.forEach(item => {
                // Hitung persentase perubahan berdasarkan average_price
                const persen = ((item.current_price - item.average_price) / item.average_price) * 100;
                const isNaik = persen > 0;

                const persenText = (isNaik ? "+" : "") + persen.toFixed(1) + "%";
                const kelasWarna = isNaik ? "price-up" : "price-down";
                const hargaText = item.current_price.toLocaleString('id-ID') + ` / ${item.unit}`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.commodity_name}</strong></td>
                    <td style="font-weight: bold;">Rp ${hargaText}</td>
                    <td class="${kelasWarna}">${persenText}</td>
                `;
                hargaBody.appendChild(row);
            });
        }

        // --- 5. RENDER TREN CHART ---
        function renderTrendChart(prices) {
            let htmlContent = '';
            
            // Ambil top 3 harga tertinggi untuk grafik
            const topItems = [...prices].sort((a,b) => b.current_price - a.current_price).slice(0, 3);
            const maxPrice = topItems[0].current_price;

            topItems.forEach(item => {
                const percentage = (item.current_price / maxPrice) * 100;
                const isNaik = (item.current_price > item.average_price);
                const warnaBar = isNaik ? "trend-up" : "trend-down";
                const hargaText = item.current_price.toLocaleString('id-ID');

                htmlContent += `
                    <div class="trend-bar">
                        <div class="trend-label">
                            <span>${item.commodity_name}</span>
                            <span>Rp ${hargaText}</span>
                        </div>
                        <div class="trend-bg">
                            <div class="trend-fill ${warnaBar}" style="width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            });

            trendChart.innerHTML = htmlContent;
        }

        // --- 6. LOGIKA REKOMENDASI ---
        function analisaRekomendasi(prices) {
            recCard.style.display = 'block';

            // Logika:
            // 1. Cari harga di bawah rata-rata -> BELI (Petani Hemat)
            // 2. Cari harga di atas rata-rata -> JUAL (Petani Untung)
            
            const barangMurah = prices.find(p => p.current_price < p.average_price);
            const barangMahal = prices.find(p => p.current_price > p.average_price);

            if (barangMurah && barangMahal) {
                recBadge.className = "rec-badge rec-buy";
                recBadge.textContent = "SARAN: BELI";
                recTitle.textContent = `Harga ${barangMurah.commodity_name} DI BAWAR RATA-RATA`;
                recSubtitle.textContent = "Saat yang tepat untuk membeli bibit atau pupuk.";
            } else if (barangMahal && !barangMurah) {
                recBadge.className = "rec-badge rec-sell";
                recBadge.textContent = "SARAN: JUAL";
                recTitle.textContent = `Harga ${barangMahal.commodity_name} MELONJAK`;
                recSubtitle.textContent = "Permintaan pasar tinggi. Waktunya menjual hasil panen.";
            } else {
                recBadge.className = "rec-badge rec-hold";
                recBadge.textContent = "NETRAL";
                recTitle.textContent = "Harga Pasar Stabil";
                recSubtitle.textContent = "Tidak ada pergerakan harga yang signifikan hari ini.";
            }
        }
    </script>
</body>
</html>
