<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - AgriChain</title>

<!-- SUPABASE CDN v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #e8f5e9;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
.card {
    background: white;
    padding: 30px;
    width: 360px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.1);
}
input, button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
}
button {
    background: #2e7d32;
    color: white;
    border: none;
    font-weight: bold;
}
.error {
    color: red;
    margin-top: 10px;
}
</style>
</head>

<body>

<div class="card">
    <h2>ðŸŒ± AgriChain</h2>
    <p>Masuk ke akun Anda</p>

    <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button type="submit">MASUK</button>
        <div class="error" id="errorMsg"></div>
    </form>
</div>

<script>
/* =====================================================
   1ï¸âƒ£ KONFIGURASI SUPABASE
===================================================== */

// GANTI DENGAN PUNYA ANDA
const SUPABASE_URL = "https://nkcctncsjmcfsiguowms.supabase.co";
const SUPABASE_ANON_KEY = "PASTE_ANON_KEY_DI_SINI";

// INIT CLIENT (INI YANG BENAR)
const { createClient } = window.supabase;
const supabaseClient = createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
);

/* =====================================================
   2ï¸âƒ£ LOGIN FORM
===================================================== */

const form = document.getElementById("loginForm");
const errorMsg = document.getElementById("errorMsg");

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    errorMsg.textContent = "";

    try {
        /* 1. LOGIN AUTH */
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
        });

        if (error) throw error;

        /* 2. AMBIL PROFIL */
        const { data: profile, error: profileError } = await supabaseClient
            .from("profiles")
            .select("full_name, role")
            .eq("id", data.user.id)
            .single();

        if (profileError) throw profileError;

        /* 3. SIMPAN SESSION (OPSIONAL UI) */
        localStorage.setItem("agrichain_user", JSON.stringify({
            id: data.user.id,
            email: data.user.email,
            name: profile.full_name,
            role: profile.role
        }));

        /* 4. REDIRECT */
        if (profile.role === "petani") {
            window.location.href = "dashboard.html";
        } else if (profile.role === "pembeli") {
            window.location.href = "market.html";
        } else {
            window.location.href = "index.html";
        }

    } catch (err) {
        console.error(err);
        errorMsg.textContent = "Email atau password salah";
    }
});
</script>

</body>
</html>
