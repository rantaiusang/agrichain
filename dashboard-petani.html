<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Petani - AgriChain</title>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root { --primary: #2E7D32; --primary-dark: #1B5E20; --light-green: #E8F5E9; --bg: #F8FAF9; --white: #ffffff; --text: #1F2937; --sub: #6B7280; --radius: 16px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        
        .profile-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 40px 20px 100px 20px; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .user-info h2 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .role-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.4); }

        .stats-wrapper { display: flex; gap: 15px; margin: -50px auto 20px; position: relative; z-index: 10; padding: 0 20px; }
        .stat-card { background: var(--white); flex: 1; padding: 15px; border-radius: var(--radius); box-shadow: 0 10px 20px rgba(46, 125, 50, 0.2); text-align: center; animation: slideDown 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--sub); font-weight: 600; }
        .stat-value { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin: 5px 0; }
        .stat-sub { font-size: 0.75rem; color: #9CA3AF; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: var(--white); border-radius: var(--radius); padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; border:1px solid #E5E7EB; }
        .chart-box { height: 200px; position: relative; width: 100%; }

        .list-item { background: var(--white); padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid transparent; opacity: 0; animation: fadeInUp 0.5s ease forwards; transition: transform 0.2s; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .list-item:hover { transform: translateX(5px); border-color: var(--light-green); }
        .item-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .item-icon { width: 45px; height: 45px; background: var(--light-green); color: var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; }
        .item-title { font-weight: 700; font-size: 1rem; color: var(--text); margin-bottom: 2px; }
        .item-meta { font-size: 0.8rem; color: var(--sub); }
        .item-right { text-align: right; }
        .item-price { font-weight: 800; font-size: 1.1rem; color: var(--primary); margin-bottom: 4px; }
        .badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; }
        .badge-pending { background: #FFFBEB; color: #B45309; }
        .badge-approved { background: #ECFDF5; color: #059669; }
        .badge-sold { background: #EFF6FF; color: #2563EB; }

        .btn-main { width: 100%; background: var(--primary); color: white; padding: 20px; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 10px 20px rgba(46, 125, 50, 0.4); transition: all 0.3s; text-decoration: none; margin-top: 30px; }
        .btn-main:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 15px 30px rgba(46, 125, 50, 0.5); }

        .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 10px 0; background: var(--white); border-top: 1px solid #ddd; z-index: 99; }
        .b-item { text-decoration: none; color: var(--sub); font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .b-item.active { color: var(--primary); }
        .b-item svg { width: 24px; height: 24px; }
    </style>
</head>
<body>
    <div class="profile-header">
        <div class="top-bar"><div class="brand">üåæ AgriChain</div><div class="settings-icon" onclick="window.location.href='profile.html'">‚öôÔ∏è</div></div>
        <div class="user-info"><h2 id="userName">Loading...</h2><p><span class="role-badge">PETANI</span> <span id="userDate"></span></p></div>
    </div>

    <div class="stats-wrapper">
        <div class="stat-card"><div class="stat-label">Total Panen</div><div class="stat-value" id="statCount">...</div><div class="stat-sub">Transaksi</div></div>
        <div class="stat-card"><div class="stat-label">Estimasi Cuan</div><div class="stat-value" id="statRev" style="font-size:1.2rem;">Rp 0</div><div class="stat-sub">Pending</div></div>
    </div>

    <div class="container">
        <div class="card"><h3 style="margin:0 0 15px 0; color:var(--text);">Performa Penjualan</h3><div class="chart-box"><canvas id="salesChart"></canvas></div></div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:var(--text);">Riwayat Panen</h3>
            <a href="riwayat.html" style="color:var(--primary); text-decoration:none; font-size:0.85rem; font-weight:600;">Lihat Semua</a>
        </div>

        <div id="harvestList"><div style="text-align:center; padding:20px; color:#999;">Memuat data panen...</div></div>

        <a href="input-panen.html" class="btn-main"><span style="font-size:1.5rem;">üåæ</span> Jual Hasil Panen Baru</a>
    </div>

    <nav class="nav-bottom">
        <a href="index.html" class="b-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2z"></path></svg>Beranda</a>
        <a href="belanja.html" class="b-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><path d="M1 1h4l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>Belanja</a>
        <a href="dashboard-petani.html" class="b-item active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>Panen</a>
        <a href="profile.html" class="b-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>Profil</a>
    </nav>

    <script>
        const { supabase } = window;
        const supabaseClient = supabase.createClient(window.appConfig.supabaseUrl, window.appConfig.supabaseKey);
        let currentUser = null;
        let chartInstance = null;

        document.addEventListener("DOMContentLoaded", async () => {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) { alert("Anda belum login."); window.location.href = 'login.html'; return; }
            currentUser = session.user;
            const { data: profile } = await supabaseClient.from('profiles').select('full_name, role').eq('id', currentUser.id).single();
            if (!profile || profile.role !== 'PETANI') { alert("Akses Ditolak."); window.location.href = 'index.html'; return; }
            document.getElementById('userName').textContent = "Halo, " + (profile.full_name.split(' ')[0] || "Petani");
            await loadHarvestData();
        });

        async function loadHarvestData() {
            const listEl = document.getElementById('harvestList');
            const statCount = document.getElementById('statCount');
            const statRev = document.getElementById('statRev');
            try {
                const { data, error } = await supabaseClient.from('panen').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(5);
                if (error) throw error;
                statCount.textContent = data.length;
                const totalRev = data.reduce((acc, item) => acc + (item.estimated_total || 0), 0);
                statRev.textContent = "Rp " + totalRev.toLocaleString('id-ID');
                listEl.innerHTML = '';
                if (data.length === 0) {
                    listEl.innerHTML = `<div style="text-align:center; padding:40px; color:#999;"><div style="font-size:3rem; margin-bottom:10px;">üì≠</div>Belum ada panen.<br>Mulai jual hasil panen Anda!</div>`;
                    renderChart([]);
                } else {
                    renderList(data);
                    renderChart(data);
                }
            } catch (err) { console.error("Gagal load data:", err); listEl.innerHTML = '<div style="text-align:center; color:red;">Gagal load data.</div>'; }
        }

        function renderList(data) {
            const listEl = document.getElementById('harvestList');
            listEl.innerHTML = '';
            data.forEach((item, index) => {
                const date = new Date(item.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                let badgeClass = 'badge-pending'; let badgeText = 'Menunggu';
                if(item.status === 'approved') { badgeClass = 'badge-approved'; badgeText = 'Disetujui'; }
                if(item.status === 'sold') { badgeClass = 'badge-sold'; badgeText = 'Terjual'; }
                const el = document.createElement('div'); el.className = 'list-item'; el.style.animationDelay = `${index * 0.1}s`;
                el.innerHTML = `<div class="item-left"><div class="item-icon">üåæ</div><div><div class="item-title">${item.nama_komoditas}</div><div class="item-meta">${item.quantity} ${item.unit} ‚Ä¢ ${date}</div></div></div><div class="item-right"><div class="item-price">Rp ${item.estimated_total.toLocaleString()}</div><span class="badge ${badgeClass}">${badgeText}</span></div>`;
                listEl.appendChild(el);
            });
        }

        function renderChart(data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();
            const labels = data.map(d => d.nama_komoditas.substring(0,10) + '..');
            const values = data.map(d => d.estimated_total);
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: labels.length ? labels : ['Belum ada data'], datasets: [{ label: 'Estimasi Pendapatan', data: values.length ? values : [0], borderColor: '#2E7D32', backgroundColor: 'rgba(46, 125, 50, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
            });
        }
    </script>
</body>
</html>
