<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokumen Petani - AgriChain</title>
    
    <!-- Library Blockchain -->
    <script src="https://unpkg.com/@web3modal/web3modal"></script>
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <style>
        :root {
            --primary-green: #2E7D32;
            --light-green: #E8F5E9;
            --dark-green: #1B5E20;
            --text-dark: #333;
            --text-grey: #666;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        h2 { color: var(--primary-green); margin-top: 0; margin-bottom: 25px; text-align: center; }

        /* --- UPLOAD AREA --- */
        .upload-area {
            border: 2px dashed var(--primary-green);
            background: var(--light-green);
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover { background: #dcedc8; }
        .upload-icon { font-size: 3rem; color: var(--primary-green); margin-bottom: 10px; }
        .upload-text { color: var(--text-grey); font-size: 1.1rem; }

        input[type="file"] { display: none; }

        /* --- FORM METADATA --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-upload {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-upload:hover { background-color: var(--dark-green); }

        /* --- TABLE --- */
        .table-responsive {
            overflow-x: auto;
        margin-top: 30px;
        border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--light-green);
            color: var(--primary-green);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fafafa; }

        /* --- ACTION BUTTONS --- */
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-right: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-preview { background: #e3f2fd; color: #1565c0; }
        .btn-download { background: #e8f5e9; color: #2E7D32; }
        .btn-delete { background: #ffebee; color: #c62828; }
        .btn-preview:hover, .btn-download:hover { filter: brightness(0.9); }
        .btn-delete:hover { background: #ffcdd2; color: #d32f2f; }

        /* --- BADGE --- */
        .badge-file {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-pdf { background: #ffebee; color: #c62828; }
        .badge-img { background: #e3f2fd; color: #1565c0; }

        /* --- PREVIEW MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }

        .preview-img { max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-bottom: 15px; }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }
        .close-btn:hover { color: #333; }

        /* --- LOADING --- */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <h2>üìÅ Arsip Dokumen Petani</h2>
            
            <!-- AREA UPLOAD -->
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <div class="upload-text">Klik untuk upload sertifikat / bukti panen</div>
                <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
            </div>

            <!-- FORM NAMA DOKUMEN -->
            <div id="metadataForm" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <div class="form-group">
                    <label for="namaDokumen">Nama Dokumen</label>
                    <input type="text" id="namaDokumen" placeholder="Contoh: Sertifikat Pupuk NPK 2023" required>
                </div>
                <div class="form-group">
                    <label for="kategori">Kategori</label>
                    <select id="kategori" required>
                        <option value="">Pilih Kategori...</option>
                        <option value="Sertifikat Tanah">Sertifikat Tanah</option>
                        <option value="Bukti Panen">Bukti Panen</option>
                        <option value="Pelatihan">Pelatihan / Sertifikasi Skill</option>
                        <option value="KTP">KTP (Identitas)</option>
                    </select>
                </div>
                <button type="button" id="btnUpload" class="btn-upload" onclick="handleUpload()">
                    <span class="spinner" id="spinner"></span>
                    <span id="btnText">Simpan Dokumen</span>
                </button>
            </div>

        <!-- TABEL DAFTAR DOKUMEN -->
            <div class="table-responsive">
                <table id="tabelDokumen">
                    <thead>
                        <tr>
                            <th>Nama File</th>
                            <th>Kategori</th>
                            <th>Tanggal Upload</th>
                            <th>Ukuran</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelBody">
                        <!-- Data akan dirender JS -->
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">Memuat dokumen...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TOMBOL KEMBALI -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="index.html" style="color: #666; text-decoration: none; font-weight: bold;">&larr; Kembali ke Beranda</a>
            </div>
        </div>
    </div>

    <!-- MODAL PREVIEW -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePreview()">&times;</span>
            <h3 style="color: #333; margin-bottom: 10px;">Preview Dokumen</h3>
            <div id="previewContainer">
                <!-- Gambar atau Ikon PDF akan muncul di sini -->
            </div>
            <button onclick="closePreview()" style="margin-top: 15px; padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">Tutup</button>
        </div>
    </div>

    <script type="module">
        // --- DATA DUMMY (Simulasi Supabase Storage) ---
        // Karena backend offline, kita simpan file dalam objek JavaScript (Blob URL)
        let fileDB = [
            { 
                id: 1, 
                nama: "Sertifikat Lahan Sawah", 
                kategori: "Sertifikat Tanah", 
                namaFile: "sertifikat_lahan.jpg", 
                type: "image/jpeg", 
                size: 1024 * 500, // 500KB (dummy)
                date: "2023-10-01" 
            },
            { 
                id: 2, 
                nama: "Bukti Panen Jagung", 
                kategori: "Bukti Panen", 
                namaFile: "bukti_jagung.pdf", 
                type: "application/pdf", 
                size: 1024 * 250, // 250KB (dummy)
                date: "2023-10-15" 
            }
        ];

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const metadataForm = document.getElementById('metadataForm');
        const btnUpload = document.getElementById('btnUpload');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const tabelBody = document.getElementById('tabelBody');
        const previewModal = document.getElementById('previewModal');
        const previewContainer = document.getElementById('previewContainer');

        // 1. FUNGSI TAMPILKAN FORM (Jika file dipilih)
        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                metadataForm.style.display = 'block';
                // Scroll ke bawah otomatis
                metadataForm.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // 2. FUNGSI UPLOAD (Simulasi Supabase Storage)
        window.handleUpload = function() {
            const file = fileInput.files[0];
            const nama = document.getElementById('namaDokumen').value;
            const kategori = document.getElementById('kategori').value;

            if (!file || !nama || !kategori) {
                alert("Harap pilih file dan isi nama dokumen!");
                return;
            }

            // Validasi Tipe File (Hanya PDF dan Gambar)
            if (file.type !== 'application/pdf' && !file.type.startsWith('image/')) {
                alert("Hanya file PDF dan Gambar (JPG/PNG) yang diperbolehkan!");
                return;
            }

            // UI Loading
            btnText.textContent = "Mengunggah...";
            btnUpload.disabled = true;
            spinner.style.display = "inline-block";

            try {
                // Simulasi Upload ke Supabase (Delay 1.5 detik)
                await new Promise(r => setTimeout(r, 1500));

                // Convert File ke Blob URL (Untuk Preview Local)
                const blobUrl = URL.createObjectURL(file);
                
                const newId = fileDB.length + 1;
                const newDoc = {
                    id: newId,
                    nama: nama,
                    kategori: kategori,
                    namaFile: file.name,
                    type: file.type,
                    size: file.size,
                    blobUrl: blobUrl, // URL sementara untuk preview/download
                    date: new Date().toLocaleDateString('id-ID')
                };

                fileDB.unshift(newDoc); // Tambah ke array

                // Reset Form
                fileInput.value = '';
                document.getElementById('namaDokumen').value = '';
                document.getElementById('kategori').value = '';
                metadataForm.style.display = 'none';

                renderTable(); // Update Tabel
                alert("Dokumen berhasil diunggah ke Arsip!");

            } catch (err) {
                console.error(err);
                alert("Gagal mengunggah dokumen.");
            } finally {
                btnText.textContent = "Simpan Dokumen";
                btnUpload.disabled = false;
                spinner.style.display = "none";
            }
        };

        // 3. FUNGSI PREVIEW (LIHAT FILE)
        window.previewFile = function(id) {
            const doc = fileDB.find(d => d.id === id);
            if (!doc) return;

            if (doc.type === 'application/pdf') {
                previewContainer.innerHTML = `
                    <div style="font-size: 3rem; color: #c62828;">üìÑ</div>
                    <p style="margin-top: 10px;"><strong>${doc.namaFile}</strong></p>
                    <p style="color: #666;">File PDF (Tidak bisa dipreview langsung di browser)</p>
                    <a href="#" style="color: #2E7D32; font-weight: bold; text-decoration: underline;" onclick="downloadFile(${id})">Download untuk melihat</a>
                `;
            } else {
                // Gambar
                previewContainer.innerHTML = `
                    <img src="${doc.blobUrl}" class="preview-img" alt="Preview">
                    <p><strong>${doc.nama}</strong></p>
                    <p style="color: #666;">${doc.kategori}</p>
                `;
            }

            previewModal.style.display = "flex";
        }

        // 4. FUNGSI DOWNLOAD
        window.downloadFile = function(id) {
            const doc = fileDB.find(d => d.id === id);
            if (!doc) return;

            // Buat elemen link sementara untuk trigger download
            const a = document.createElement('a');
            a.href = doc.blobUrl;
            a.download = doc.namaFile;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // 5. FUNGSI HAPUS
        window.hapusDokumen = function(id) {
            const confirmHapus = confirm("Hapus dokumen ini dari arsip? Anda tidak bisa memulihkannya.");
            if (confirmHapus) {
                fileDB = fileDB.filter(d => d.id !== id);
                renderTable();
            }
        };

        // 6. FUNGSI TUTUP PREVIEW
        window.closePreview = function() {
            previewModal.style.display = "none";
            previewContainer.innerHTML = '';
        }

        // 7. RENDER TABEL
        function renderTable() {
            tabelBody.innerHTML = '';

            if (fileDB.length === 0) {
                tabelBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Belum ada dokumen yang diunggah.</td></tr>';
                return;
            }

            fileDB.forEach(item => {
                // Tentukan Badge berdasarkan Tipe File
                const badgeClass = item.type === 'application/pdf' ? 'badge-pdf' : 'badge-img';
                const badgeText = item.type === 'application/pdf' ? 'PDF' : 'IMG';

                // Format Ukuran (KB / MB)
                let size = item.size / 1024;
                let sizeStr = size.toFixed(1) + ' KB';
                if (size > 1024) {
                    sizeStr = (size / 1024).toFixed(1) + ' MB';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${item.nama}</strong>
                        <br><span class="badge-file ${badgeClass}">${badgeText}</span>
                    </td>
                    <td>${item.kategori}</td>
                    <td>${item.date}</td>
                    <td>${sizeStr}</td>
                    <td>
                        <a href="#" class="action-btn btn-preview" onclick="previewFile(${item.id})">Lihat</a>
                        <a href="#" class="action-btn btn-download" onclick="downloadFile(${item.id})">Unduh</a>
                        <a href="#" class="action-btn btn-delete" onclick="hapusDokumen(${item.id})">Hapus</a>
                    </td>
                `;
                tabelBody.appendChild(row);
            });
        }

        // 8. INIT
        document.addEventListener("DOMContentLoaded", () => {
            // Cek Login Sesi (Opsional)
            const token = localStorage.getItem('agrichain_token');
            if (!token) {
                alert("Anda belum login. Silakan login terlebih dahulu.");
                window.location.href = 'login.html';
            } else {
                renderTable();
            }
        });
    </script>
</body>
</html>
