<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokumen Petani - AgriChain</title>
    
    <!-- Library Blockchain (Opsional) & Supabase -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-green: #2E7D32;
            --light-green: #E8F5E9;
            --dark-green: #1B5E20;
            --text-dark: #333;
            --text-grey: #666;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        h2 { color: var(--primary-green); margin-top: 0; margin-bottom: 25px; text-align: center; }

        /* --- UPLOAD AREA --- */
        .upload-area {
            border: 2px dashed var(--primary-green);
            background: var(--light-green);
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover { background: #dcedc8; }
        .upload-icon { font-size: 3rem; color: var(--primary-green); margin-bottom: 10px; }
        .upload-text { color: var(--text-grey); font-size: 1.1rem; }

        input[type="file"] { display: none; }

        /* --- FORM METADATA --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark); }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .btn-upload {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-upload:hover { background-color: var(--dark-green); }
        .btn-upload:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- TABLE --- */
        .table-responsive {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--light-green);
            color: var(--primary-green);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fafafa; }

        /* --- ACTION BUTTONS --- */
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-right: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-preview { background: #e3f2fd; color: #1565c0; }
        .btn-delete { background: #ffebee; color: #c62828; }
        .btn-preview:hover { filter: brightness(0.9); }
        .btn-delete:hover { background: #ffcdd2; color: #d32f2f; }

        /* --- BADGE --- */
        .badge-file {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .badge-pdf { background: #ffebee; color: #c62828; }
        .badge-img { background: #e3f2fd; color: #1565c0; }

        /* --- PREVIEW MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .preview-img { max-width: 100%; border-radius: 8px; }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }
        .close-btn:hover { color: #333; }

        /* --- LOADING --- */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <h2>üìÅ Arsip Dokumen Petani</h2>
            
            <!-- AREA UPLOAD -->
            <div class="upload-area" id="dropZone">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <div class="upload-text">Klik atau Tarik File ke sini</div>
                <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
            </div>

            <!-- FORM NAMA DOKUMEN -->
            <div id="metadataForm" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <div class="form-group">
                    <label for="namaDokumen">Nama Dokumen</label>
                    <input type="text" id="namaDokumen" placeholder="Contoh: Sertifikat Pupuk NPK 2023" required>
                </div>
                <div class="form-group">
                    <label for="kategori">Kategori</label>
                    <select id="kategori" required>
                        <option value="">Pilih Kategori...</option>
                        <option value="Sertifikat Tanah">Sertifikat Tanah</option>
                        <option value="Bukti Panen">Bukti Panen</option>
                        <option value="Pelatihan">Pelatihan / Sertifikasi Skill</option>
                        <option value="KTP">KTP (Identitas)</option>
                    </select>
                </div>
                <button type="button" id="btnUpload" class="btn-upload" onclick="handleUpload()">
                    <span class="spinner" id="spinner"></span>
                    <span id="btnText">Simpan Dokumen</span>
                </button>
            </div>

        <!-- TABEL DAFTAR DOKUMEN -->
            <div class="table-responsive">
                <table id="tabelDokumen">
                    <thead>
                        <tr>
                            <th>Nama File</th>
                            <th>Kategori</th>
                            <th>Tanggal Upload</th>
                            <th>Ukuran</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tabelBody">
                        <!-- Data akan dirender JS -->
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">Memuat dokumen...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TOMBOL KEMBALI -->
            <div style="text-align: center; margin-top: 20px;">
                <a href="index.html" style="color: #666; text-decoration: none; font-weight: bold;">&larr; Kembali ke Beranda</a>
            </div>
        </div>
    </div>

    <!-- MODAL PREVIEW -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closePreview()">&times;</span>
            <h3 style="color: #333; margin-bottom: 10px;">Preview Dokumen</h3>
            <div id="previewContainer">
                <!-- Gambar atau Ikon PDF akan muncul di sini -->
            </div>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://xyzcompany.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const BUCKET_NAME = 'dokumen-petani'; // Pastikan bucket ini ada di Supabase Storage

        // --- DOM ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const metadataForm = document.getElementById('metadataForm');
        const btnUpload = document.getElementById('btnUpload');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const tabelBody = document.getElementById('tabelBody');
        const previewModal = document.getElementById('previewModal');
        const previewContainer = document.getElementById('previewContainer');
        
        let currentFile = null;
        let userId = null;

        // --- 2. CEK SESI & LOAD USER ---
        document.addEventListener("DOMContentLoaded", async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                alert("Silakan login terlebih dahulu.");
                window.location.href = 'login.html';
                return;
            }
            userId = session.user.id;
            loadDocuments();
        });

        // --- 3. HANDLER INPUT FILE ---
        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                currentFile = this.files[0];
                metadataForm.style.display = 'block';
                metadataForm.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // --- 4. FUNGSI UPLOAD KE SUPABASE STORAGE ---
        window.handleUpload = async function() {
            const nama = document.getElementById('namaDokumen').value;
            const kategori = document.getElementById('kategori').value;

            if (!currentFile || !nama || !kategori) {
                alert("Lengkapi data dan pilih file!");
                return;
            }

            // UI Loading
            btnText.textContent = "Mengunggah...";
            btnUpload.disabled = true;
            spinner.style.display = "inline-block";

            try {
                // A. Buat Nama File Unik (menggunakan Timestamp)
                const fileExt = currentFile.name.split('.').pop();
                const fileName = `${userId}/${Date.now()}.${fileExt}`;

                // B. Upload File ke Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(fileName, currentFile);

                if (uploadError) throw uploadError;

                // C. Simpan Metadata Dokumen ke Tabel Database (opsional, tapi disarankan untuk search/filter)
                // Misal ada tabel 'documents'
                /* 
                await supabase.from('documents').insert({
                    user_id: userId,
                    name: nama,
                    category: kategori,
                    storage_path: fileName
                }); 
                */
                
                // Reset Form
                fileInput.value = '';
                document.getElementById('namaDokumen').value = '';
                document.getElementById('kategori').value = '';
                metadataForm.style.display = 'none';
                currentFile = null;

                alert("Dokumen berhasil disimpan!");
                loadDocuments(); // Refresh Tabel

            } catch (err) {
                console.error("Upload Error:", err);
                alert("Gagal mengunggah: " + err.message);
            } finally {
                btnText.textContent = "Simpan Dokumen";
                btnUpload.disabled = false;
                spinner.style.display = "none";
            }
        };

        // --- 5. LOAD DOKUMEN (LIST FILES) ---
        async function loadDocuments() {
            tabelBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Memuat...</td></tr>';

            // Ambil daftar file dari folder user di storage
            const { data, error } = await supabase.storage
                .from(BUCKET_NAME)
                .list(userId);

            if (error) {
                console.error(error);
                tabelBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color:red;">Gagal memuat data.</td></tr>';
                return;
            }

            // Filter file (jangan tampilkan folder kosong)
            const files = data.filter(f => f.name !== '.emptyFolderPlaceholder'); 

            if (files.length === 0) {
                tabelBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Belum ada dokumen.</td></tr>';
                return;
            }

            renderTable(files);
        }

        // --- 6. RENDER TABEL ---
        function renderTable(files) {
            tabelBody.innerHTML = '';
            
            // Urutkan dari yang terbaru (created_at descending)
            files.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            files.forEach(file => {
                // Generate Public URL untuk akses gambar/pdf
                const { data: { publicUrl } } = supabase.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(`${userId}/${file.name}`);

                const badgeClass = file.metadata.mimetype.includes('pdf') ? 'badge-pdf' : 'badge-img';
                const badgeText = file.metadata.mimetype.includes('pdf') ? 'PDF' : 'IMG';
                
                const sizeKB = (file.metadata.size / 1024).toFixed(1) + ' KB';
                const date = new Date(file.created_at).toLocaleDateString('id-ID');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${file.name}</strong>
                        <br><span class="badge-file ${badgeClass}">${badgeText}</span>
                    </td>
                    <td>-</td> <!-- Kategori butuh tabel DB terpisah untuk ditampilkan dinamis -->
                    <td>${date}</td>
                    <td>${sizeKB}</td>
                    <td>
                        <a href="${publicUrl}" target="_blank" class="action-btn btn-preview">Lihat</a>
                        <a href="#" class="action-btn btn-delete" onclick="deleteFile('${file.name}')">Hapus</a>
                    </td>
                `;
                tabelBody.appendChild(row);
            });
        }

        // --- 7. FUNGSI PREVIEW ---
        window.previewFile = function(fileName) {
            const { data: { publicUrl } } = supabase.storage.from(BUCKET_NAME).getPublicUrl(`${userId}/${fileName}`);
            
            const isImg = fileName.match(/\.(jpeg|jpg|gif|png)$/) != null;

            if (isImg) {
                previewContainer.innerHTML = `<img src="${publicUrl}" class="preview-img">`;
            } else {
                previewContainer.innerHTML = `<p>File PDF/Gambar tidak dapat dipreview langsung.</p><a href="${publicUrl}" target="_blank">Klik disini untuk melihat</a>`;
            }
            previewModal.style.display = "flex";
        };

        window.closePreview = function() {
            previewModal.style.display = "none";
        }

        // --- 8. FUNGSI HAPUS ---
        window.deleteFile = async function(fileName) {
            if(confirm("Hapus dokumen ini permanen?")) {
                const { error } = await supabase.storage
                    .from(BUCKET_NAME)
                    .remove([`${userId}/${fileName}`]);
                
                if(error) alert("Gagal menghapus: " + error.message);
                else {
                    loadDocuments();
                    alert("Dokumen dihapus.");
                }
            }
        };
    </script>
</body>
</html>
