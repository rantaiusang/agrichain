<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Reset Kata Sandi - AgriChain</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f0f0f0; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 320px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #2E7D32; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .msg { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Reset Password</h2>
        <div id="statusMsg" class="msg">Memuat token...</div>

        <form id="resetForm">
            <input type="text" id="token" placeholder="Masukkan Token" readonly style="background: #eee; font-family: monospace;">
            <input type="password" id="newPassword" placeholder="Password Baru">
            <button type="submit">Ganti Password</button>
        </form>

        <a href="../public/login.html" style="display:block; margin-top:15px; color:#666;">← Kembali ke Login</a>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="module">
        const BACKEND_URL = "http://localhost:3000";

        // 1. Ambil Token dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        const tokenInput = document.getElementById('token');
        const statusMsg = document.getElementById('statusMsg');
        const form = document.getElementById('resetForm');

        // 2. Isi otomatis Token
        if (token) {
            tokenInput.value = token;
            statusMsg.textContent = "Token ditemukan. Silakan masukkan password baru.";
            statusMsg.className = "msg";
        } else {
            statusMsg.textContent = "Token tidak ditemukan. Pastikan Anda membuka link dari WhatsApp.";
            statusMsg.className = "msg error";
            form.style.display = 'none';
        }

        // 3. Handle Submit Form
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;

            if (!newPassword) {
                alert("Password baru wajib diisi.");
                return;
            }

            try {
                const res = await axios.post(`${BACKEND_URL}/api/reset-password`, {
                    token: token,
                    newPassword: newPassword
                });

                if (res.data.success) {
                    document.body.innerHTML = `
                        <div class="card">
                            <h1 class="success">Berhasil! ✅</h1>
                            <p>Password Anda sudah diganti.</p>
                            <a href="../public/login.html" style="color:#2E7D32; font-weight:bold;">Klik untuk Login</a>
                        </div>
                    `;
                } else {
                    alert("Gagal: " + res.data.message);
                }

            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan saat reset password.");
            }
        });
    </script>
</body>
</html>
