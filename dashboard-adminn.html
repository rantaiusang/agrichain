<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Control - AgriAdmin</title>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Library Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root { --primary: #1A237E; --secondary: #3949AB; --gold: #FFD700; --bg: #F5F7FA; --text: #333; --danger: #D32F2F; }
        body { font-family: "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; min-height: 100vh; color: var(--text); }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; position: fixed; height: 100%; left: 0; top: 0; z-index: 100; overflow-y: auto; transition: transform 0.3s ease; }
        .brand { font-size: 1.4rem; font-weight: bold; margin-bottom: 40px; color: var(--gold); display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.7); text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); color: white; }
        
        /* Main Content */
        .main-content { margin-left: 250px; flex: 1; padding: 30px; transition: margin-left 0.3s; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--primary); margin: 0; font-size: 1.8rem; }
        .header p { margin: 5px 0 0 0; color: #666; font-size: 0.9rem; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .stat-lbl { font-size: 0.9rem; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        .master-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 25px; border-left: 6px solid var(--secondary); display: flex; flex-direction: column; }
        
        .card-header { display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .card-icon { width: 50px; height: 50px; background: #F5F7FA; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; color: var(--primary); }
        .card-title { font-size: 1.1rem; font-weight: bold; }
        .card-subtitle { font-size: 0.85rem; color: #888; }
        
        .chart-box { position: relative; height: 220px; width: 100%; margin-bottom: 15px; }
        
        .list-ul { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .list-ul li { padding: 10px 0; border-bottom: 1px solid #f5f5f5; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-petani { background: #E8F5E9; color: #2E7D32; }
        .badge-pembeli { background: #FFF3E0; color: #EF6C00; }
        
        .btn-action { margin-top: 15px; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; text-align: center; text-decoration: none; font-weight: 600; display: block; transition: background 0.2s; }
        .btn-action:hover { background: var(--secondary); }
        
        .btn-logout { margin-top: auto; color: #ff8a80; border: 1px solid #ff8a80; cursor: pointer; text-align: center; padding: 15px; border-radius: 6px; background: transparent; transition: all 0.2s; }
        .btn-logout:hover { background: rgba(255, 138, 128, 0.1); }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 0; padding: 0; } 
            .main-content { margin-left: 0; padding: 15px; } 
            .master-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="brand">üèõÔ∏è AgriAdmin</div>
        <a href="dashboard-admin.html" class="nav-item active">üìä Master Control</a>
        <div class="nav-item" onclick="alert('Fitur ini dalam pengembangan')">üåæ Kelola Harga</div>
        <div class="nav-item" onclick="alert('Fitur ini dalam pengembangan')">üë• Users</div>
        <div class="btn-logout" id="btnLogout">üö™ Keluar Akun</div>
    </nav>

    <div class="main-content">
        <div class="header">
            <div>
                <h1>Pusat Kendali</h1>
                <p>Monitoring sistem secara real-time.</p>
            </div>
            <button onclick="refreshData()" style="padding:10px 20px; background:white; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.05);">üîÑ Refresh Data</button>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-val" id="cUsers">...</div>
                <div class="stat-lbl">Total User</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="cPanen">...</div>
                <div class="stat-lbl">Data Panen</div>
            </div>
            <div class="stat-card" style="border-top-color: #43A047;">
                <div class="stat-val" style="color:#43A047;" id="cRev">Rp 0</div>
                <div class="stat-lbl">Estimasi Revenue</div>
            </div>
        </div>

        <div class="master-grid">
            <!-- Card 1: Keuangan -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üí∞</div>
                    <div>
                        <div class="card-title">Keuangan</div>
                        <div class="card-subtitle">Tren Pendapatan (7 Hari)</div>
                    </div>
                </div>
                <div class="chart-box">
                    <canvas id="revChart"></canvas>
                </div>
                <a href="#" class="btn-action">Lihat Laporan Lengkap</a>
            </div>

            <!-- Card 2: Users -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üë•</div>
                    <div>
                        <div class="card-title">Pengguna</div>
                        <div class="card-subtitle">Sebaran Role</div>
                    </div>
                </div>
                <div class="chart-box">
                    <canvas id="usrChart"></canvas>
                </div>
                <ul class="list-ul" id="usrList">
                    <!-- User list will be injected here -->
                </ul>
            </div>

            <!-- Card 3: Alerts -->
            <div class="card" style="border-left-color: var(--danger);">
                <div class="card-header">
                    <div class="card-icon" style="color: var(--danger);">‚ö†Ô∏è</div>
                    <div>
                        <div class="card-title">Sistem</div>
                        <div class="card-subtitle">Log Aktivitas</div>
                    </div>
                </div>
                <div class="chart-box" style="display: flex; align-items: center; justify-content: center; color: #2E7D32; font-weight: bold; font-size: 1.2rem; flex-direction: column;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">‚úÖ</div>
                    Sistem Stabil
                </div>
                <ul class="list-ul" id="alertList">
                    <li><span>User Login</span> <span style="color:#888; font-size:0.8rem;">Baru saja</span></li>
                    <li><span>DB Sync</span> <span style="color:#888; font-size:0.8rem;">5 menit lalu</span></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // --- 1. LOAD CONFIG ---
        if (typeof window.appConfig === 'undefined') {
            console.error("FATAL: config.js tidak dimuat.");
            alert("Konfigurasi sistem hilang. Mohon refresh halaman.");
        }

        const SUPABASE_URL = window.appConfig.supabaseUrl;
        const SUPABASE_KEY = window.appConfig.supabaseKey;

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let charts = {};

        // --- 2. INIT ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Cek Auth
            const { data: { session } } = await supabase.auth.getSession();
            
            if(!session) {
                // Redirect ke login jika belum login
                window.location.href = 'login.html';
                return;
            }

            // Load Data Awal
            await refreshData();
            
            // Auto Refresh setiap 5 detik
            setInterval(refreshData, 5000);
        });

        // --- 3. FUNGSI LOAD DATA ---
        async function refreshData() {
            try {
                // A. Hitung User & Panen
                const { count: countUsers } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
                const { count: countPanen } = await supabase.from('agrichain_panen').select('*', { count: 'exact', head: true }); // Sesuaikan nama tabel panen
                
                // B. Hitung Revenue (Simulasi dari data panen yang ada)
                const { data: listPanen } = await supabase.from('agrichain_panen').select('harga');
                let totalRev = 0;
                if (listPanen) {
                    totalRev = listPanen.reduce((a, b) => a + (b.harga || 0), 0);
                }

                // Update UI Angka
                document.getElementById('cUsers').innerText = countUsers || 0;
                document.getElementById('cPanen').innerText = countPanen || 0;
                document.getElementById('cRev').innerText = "Rp " + totalRev.toLocaleString('id-ID');

                // C. Chart User Growth (Pie/Bar Chart)
                const { data: users } = await supabase.from('profiles').select('role, full_name');
                
                if (users) {
                    const petaniCount = users.filter(u => u.role === 'PETANI').length;
                    const pembeliCount = users.filter(u => u.role === 'PEMBELI').length;
                    
                    // Render Chart User
                    renderUserChart(petaniCount, pembeliCount);

                    // Render List User Terbaru
                    const ul = document.getElementById('usrList');
                    ul.innerHTML = ''; // Clear list lama
                    // Ambil 5 user terakhir
                    users.slice(-5).reverse().forEach(u => {
                        const badgeClass = u.role === 'PETANI' ? 'badge-petani' : (u.role === 'PEMBELI' ? 'badge-pembeli' : '');
                        const nama = u.full_name || 'User Tanpa Nama';
                        ul.innerHTML += `
                            <li>
                                <span>${nama}</span> 
                                <span class="badge ${badgeClass}">${u.role}</span>
                            </li>`;
                    });
                }

            } catch(e) {
                console.error("Gagal refresh data:", e);
            }
        }

        // --- 4. FUNGSI RENDER CHART (Dengan Pencegahan Error Canvas) ---
        function renderUserChart(petani, pembeli) {
            const ctx = document.getElementById('usrChart').getContext('2d');
            
            // Hancurkan chart lama jika ada, untuk mencegah error "Canvas is already in use"
            if (charts['usr']) {
                charts['usr'].destroy();
            }

            charts['usr'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Petani', 'Pembeli'],
                    datasets: [{
                        label: 'Jumlah User',
                        data: [petani, pembeli],
                        backgroundColor: ['#2E7D32', '#FF9800'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        // --- 5. LOGOUT ---
        document.getElementById('btnLogout').addEventListener('click', async () => {
            const confirmLogout = confirm("Apakah Anda yakin ingin keluar?");
            if(confirmLogout) {
                await supabase.auth.signOut();
                localStorage.clear();
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
