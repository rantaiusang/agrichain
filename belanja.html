<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Belanja Panen - AgriChain</title>
    
    <!-- 1. LOAD CONFIG (PENTING) -->
    <script src="src/config.js"></script>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS GLOBAL --- */
        :root {
            --primary-green: #2E7D32;
            --dark-green: #1B5E20;
            --light-green: #E8F5E9;
            --text-dark: #333;
            --text-grey: #666;
            --white: #ffffff;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --border: #eee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f6f8;
            color: var(--text-dark);
            margin: 0;
            padding-bottom: 80px; /* Space for navbar */
        }

        /* --- NAVBAR --- */
        .navbar {
            background: var(--white);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-green);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- CONTAINER & FILTER --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .filter-section {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 2;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .filter-select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: var(--white);
            font-size: 0.95rem;
            cursor: pointer;
        }

        /* --- GRID PRODUCT --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }

        .card-img-wrapper {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            position: relative;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-category {
            font-size: 0.75rem;
            color: var(--text-grey);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .card-meta {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-green);
            margin-top: auto;
        }

        .card-actions {
            margin-top: 15px;
            border-top: 1px solid #f5f5f5;
            padding-top: 15px;
        }

        .btn-buy {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-buy:hover { background-color: var(--dark-green); }
        .btn-buy:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .badge-pending { background: #FFF3E0; color: #F57C00; }
        .badge-approved { background: #E8F5E9; color: #2E7D32; }
        .badge-sold { background: #E3F2FD; color: #1976D2; }

        /* --- STATUS MSG --- */
        .status-msg {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
            background: white;
            border-radius: 8px;
            border: 1px dashed #ddd;
        }

        /* --- NAV BOTTOM --- */
        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background: var(--white);
            border-top: 1px solid #ddd;
            z-index: 99;
        }

        .b-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-grey);
            font-size: 0.8rem;
        }

        .b-item.active { color: var(--primary-green); }
        .b-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="index.html" class="nav-brand">üåæ AgriChain</a>
        <div>
            <a href="profile.html" style="padding: 8px 16px; border: 1px solid var(--primary-green); color: var(--primary-green); border-radius: 20px; text-decoration: none; font-weight: bold;">Profil Saya</a>
        </div>
    </nav>

    <div class="container">
        
        <!-- Filter Bar -->
        <div class="filter-section">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Cari nama komoditas...">
            </div>
            
            <!-- Filter Status -->
            <select id="filterStatus" class="filter-select">
                <option value="">Semua Status</option>
                <option value="approved">Tersedia (Approved)</option>
                <option value="sold">Terjual (Sold)</option>
            </select>
        </div>

        <!-- Grid Produk -->
        <div class="product-grid" id="productGrid">
            <div class="status-msg">Memuat data panen...</div>
        </div>

    </div>

    <!-- Navigasi Bawah -->
    <div class="nav-bottom">
        <a href="index.html" class="b-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2z"></path></svg>
            Beranda
        </a>
        <a href="belanja.html" class="b-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><path d="M1 1h4l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
            Belanja
        </a>
        <a href="profile.html" class="b-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>
            Profil
        </a>
    </div>

    <script>
        // --- 1. LOAD CONFIG & INIT ---
        if (typeof window.appConfig === 'undefined') {
            console.error("FATAL: config.js tidak dimuat.");
            alert("Konfigurasi sistem hilang. Pastikan src/config.js ada.");
        }

        const SUPABASE_URL = window.appConfig.supabaseUrl;
        const SUPABASE_KEY = window.appConfig.supabaseKey;
        // ‚úÖ PERBAIKAN: Ketik 'window' dengan benar, bukan 'wimdow'
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. DOM ELEMENTS ---
        const grid = document.getElementById('productGrid');
        const searchInput = document.getElementById('searchInput');
        const filterStatus = document.getElementById('filterStatus');

        let allProducts = [];
        let currentUser = null;

        // --- 3. INIT ---
        document.addEventListener("DOMContentLoaded", async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if(!session) { 
                console.log("Guest Mode: Belanja sebagai tamu.");
            } else {
                currentUser = session.user.id;
                console.log("User Mode:", currentUser);
            }
            
            await loadPanenData();
        });

        // --- 4. LOAD DATA (LOGIC JOIN TABEL) ---
        async function loadPanenData() {
            try {
                // Query: Ambil data panen, join dengan profiles untuk nama petani.
                // Asumsi kolom foreign key di tabel 'panen' bernama 'profiles' atau 'user_id'.
                // Kita gunakan foreign key reference standar.
                const { data, error } = await supabaseClient
                    .from('panen')
                    .select(`
                        id,
                        nama_komoditas,
                        quantity,
                        unit,
                        harga_per_unit,
                        estimated_total,
                        kualitas,
                        status,
                        created_at,
                        profiles ( full_name )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Mapping data
                allProducts = data.map(item => {
                    // Cek apakah data profile ada (untuk menghindari error jika relasi null)
                    const farmerName = item.profiles ? item.profiles.full_name : 'Petani Terdaftar';
                    
                    return {
                        id: item.id,
                        name: item.nama_komoditas || 'Tanaman',
                        seller: farmerName,
                        quantity: item.quantity,
                        unit: item.unit,
                        price: item.harga_per_unit || 0, 
                        total: item.estimated_total || 0,
                        quality: item.kualitas || 'Standard',
                        status: item.status || 'pending',
                        created_at: item.created_at
                    };
                });

                renderGrid(allProducts);

            } catch (err) {
                console.error("Gagal load panen:", err);
                grid.innerHTML = '<div class="status-msg" style="color:red;">Gagal memuat data. Cek koneksi internet atau database.</div>';
            }
        }

        // --- 5. RENDER GRID ---
        function renderGrid(products) {
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = '<div class="status-msg">Belum ada panen yang tersedia di pasar.</div>';
                return;
            }

            products.forEach(item => {
                // Gambar Placeholder Random tapi konsisten berdasarkan ID
                const imgUrl = `https://picsum.photos/seed/${item.id}/400/300`;
                
                // Logic Badge Status
                let badgeHTML = '<span class="status-badge badge-pending">Menunggu</span>';
                let isSold = false;

                if(item.status === 'approved') {
                    badgeHTML = '<span class="status-badge badge-approved">Tersedia</span>';
                } else if(item.status === 'sold') {
                    badgeHTML = '<span class="status-badge badge-sold">Terjual</span>';
                    isSold = true;
                }

                const card = document.createElement('div');
                card.className = 'card';
                
                // Opacity rendah jika pending atau sold
                if (item.status === 'pending') card.style.opacity = '0.7';

                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${imgUrl}" alt="${item.name}" class="card-img" loading="lazy">
                    </div>
                    <div class="card-body">
                        <div class="card-category">${item.quality}</div>
                        <h3 class="card-title">${item.name}</h3>
                        <div class="card-meta">
                            <span>üë§ ${item.seller}</span>
                            <span>üì¶ ${item.quantity} ${item.unit}</span>
                        </div>
                        <div class="card-price">Rp ${item.price.toLocaleString('id-ID')} / ${item.unit}</div>
                        <div class="card-meta" style="margin-top:5px;">
                            Total: <b>Rp ${item.total.toLocaleString('id-ID')}</b>
                        </div>
                        <div style="margin-top:10px; text-align:center;">${badgeHTML}</div>
                        
                        <div class="card-actions">
                            <button class="btn-buy" 
                                onclick="handleBuy(${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.total})" 
                                ${isSold ? 'disabled' : ''}>
                                ${isSold ? 'Stok Habis' : 'Beli Sekarang'}
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- 6. LOGIC FILTER & SEARCH ---
        function filterData() {
            const searchVal = searchInput.value.toLowerCase();
            const statusVal = filterStatus.value;

            const filtered = allProducts.filter(item => {
                const matchName = item.name.toLowerCase().includes(searchVal) || item.seller.toLowerCase().includes(searchVal);
                const matchStatus = statusVal === '' || item.status === statusVal;
                return matchName && matchStatus;
            });

            renderGrid(filtered);
        }

        // Event Listeners
        searchInput.addEventListener('input', filterData);
        filterStatus.addEventListener('change', filterData);

        // --- 7. LOGIC BELI (IMPLEMENTASI DATABASE) ---
        window.handleBuy = async function(id, name, totalPrice) {
            if(!currentUser) {
                alert("Silakan login terlebih dahulu untuk melakukan transaksi.");
                window.location.href = 'login.html';
                return;
            }

            // Cek stok lagi di frontend (jaga-jaga user klik cepat)
            const product = allProducts.find(p => p.id === id);
            if(product.status !== 'approved') {
                alert("Maaf, produk ini sudah tidak tersedia.");
                loadPanenData(); // Refresh data
                return;
            }

            const confirmBuy = confirm(`Apakah Anda yakin ingin membeli ${name} seharga Rp ${totalPrice.toLocaleString('id-ID')}?`);
            if(confirmBuy) {
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = "Memproses...";
                btn.disabled = true;

                try {
                    // ‚úÖ IMPLEMENTASI: Insert ke tabel 'orders'
                    const { data, error } = await supabaseClient.from('orders').insert([{
                        buyer_id: currentUser,
                        panen_id: id,
                        total_price: totalPrice,
                        status: 'pending' // Status awal order
                    }]);

                    if (error) throw error;

                    alert("Pesanan berhasil dibuat! Petani akan segera menghubungi Anda.");
                    
                    // Redirect ke dashboard pembeli untuk melihat riwayat
                    setTimeout(() => {
                        window.location.href = 'dashboard-pembeli.html';
                    }, 1000);

                } catch (err) {
                    console.error("Gagal membuat pesanan:", err);
                    alert("Gagal memproses pesanan: " + err.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        };
    </script>
</body>
</html>
