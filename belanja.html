<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Belanja Panen - AgriChain</title>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- CSS GLOBAL RESPONSIVE (AMP - Aman Mobile Professional) --- */
        :root {
            --primary-green: #2E7D32;
            --dark-green: #1B5E20;
            --light-green: #E8F5E9;
            --text-dark: #1B1B1B;
            --text-grey: #616161;
            --white: #ffffff;
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f6f8;
            color: var(--text-dark);
            margin: 0;
            padding-bottom: 80px;
        }

        /* --- HEADER --- */
        .navbar {
            background: var(--white);
            padding: 15px 20px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-green);
            text-decoration: none;
        }

        /* --- CONTAINER RESPONSIVE --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- FILTER BAR (FLEX RESPONSIVE) --- */
        .filter-bar {
            background: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-box {
            flex: 2; /* Mengambil proporsi lebar lebih besar */
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            box-sizing: border-box;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .filter-select {
            flex: 1;
            min-width: 140px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            background: white;
            font-size: 0.95rem;
            cursor: pointer;
        }

        /* --- GRID PRODUK (AUTO FIT) --- */
        .product-grid {
            display: grid;
            /* Kolom otomatis menyesuaikan layar, minimal lebar 220px */
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--white);
            border: 1px solid #eee;
            border-radius: var(--radius);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--light-green);
        }

        .card-img-wrapper {
            width: 100%;
            height: 160px;
            background: #eee;
            position: relative;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-category {
            font-size: 0.75rem;
            color: var(--text-grey);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .card-meta {
            font-size: 0.85rem;
            color: var(--text-grey);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-price {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-green);
            margin-top: auto; /* Push harga ke bawah */
            margin-bottom: 10px;
        }

        .card-actions {
            border-top: 1px solid #f0f0f0;
            padding-top: 15px;
        }

        .btn-buy {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-buy:hover { background-color: var(--dark-green); }

        .back-link {
            display: block;
            margin-top: 30px;
            text-align: center;
            color: var(--text-grey);
            text-decoration: none;
            font-weight: 600;
            padding: 12px;
            background: var(--white);
            border-radius: var(--radius);
            border: 1px solid #eee;
        }
        .back-link:hover { background: #f9f9f9; }

        /* --- LOADING & EMPTY --- */
        .status-msg {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1rem;
            grid-column: 1 / -1;
            background: white;
            border-radius: var(--radius);
            border: 1px dashed #ddd;
        }

        /* --- RESPONSIVE ADJUSTMENTS (HP) --- */
        @media (max-width: 600px) {
            .filter-bar { 
                flex-direction: column; 
                align-items: stretch; 
                gap: 10px;
            }
            .search-box, .filter-select { width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <nav class="navbar">
        <a href="index.html" class="nav-brand">üåæ AgriChain</a>
        <a href="profile.html" style="text-decoration:none; color:#333; font-weight:bold; padding:8px 16px; border:1px solid #ddd; border-radius:20px;">
            üë§ Profil
        </a>
    </nav>

    <div class="container">
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Cari komoditas...">
            </div>
            
            <!-- Filter Status (Pending/Sold) -->
            <select id="filterStatus" class="filter-select">
                <option value="">Semua Status</option>
                <option value="pending">Siap Jual (Pending)</option>
                <option value="approved">Disetujui</option>
            </select>
        </div>

        <!-- Grid Produk -->
        <div class="product-grid" id="productList">
            <div class="status-msg">Memuat data pasar...</div>
        </div>

        <a href="index.html" class="back-link">‚Üê Kembali ke Beranda</a>
    </div>

    <!-- SCRIPT UTAMA (FIXED LOGIC) -->
    <script>
        // --- 1. KONFIGURASI SUPABASE (FIXED) ---
        const SUPABASE_URL = 'https://nkcctncsjmcfsiguowms.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_CY2GLPbRJRDcRAyPXzOD4Q_63uR5W9X';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. DOM ELEMENTS ---
        const productList = document.getElementById('productList');
        const searchInput = document.getElementById('searchInput');
        const filterStatus = document.getElementById('filterStatus');

        let allProducts = [];

        // --- 3. LOAD DATA ---
        document.addEventListener("DOMContentLoaded", async () => {
            await loadProducts();
        });

        async function loadProducts() {
            try {
                // PERBAIKAN: Mengambil data dari tabel 'panen' (Bukan agrichain_product)
                // Kita JOIN dengan tabel 'profiles' untuk mendapatkan nama petani
                const { data, error } = await supabase
                    .from('panen')
                    .select(`
                        id,
                        commodity_name,
                        quantity,
                        unit,
                        price_per_unit,
                        estimated_total,
                        quality,
                        status,
                        created_at,
                        profiles!inner ( full_name ) 
                    `)
                    .order('created_at', { ascending: false }); // Terbaru diatas

                if (error) throw error;

                // Flatten data untuk kemudahan
                allProducts = data.map(item => ({
                    id: item.id,
                    name: item.commodity_name,
                    seller: item.profiles.full_name,
                    quantity: item.quantity,
                    unit: item.unit,
                    price: item.price_per_unit,
                    total: item.estimated_total,
                    quality: item.quality,
                    status: item.status,
                    created_at: item.created_at
                }));

                renderGrid(allProducts);

            } catch (err) {
                console.error("Gagal load produk:", err);
                productList.innerHTML = '<div class="status-msg" style="color:red;">Gagal memuat data produk.</div>';
            }
        }

        // --- 4. RENDER GRID ---
        function renderGrid(products) {
            productList.innerHTML = '';

            if (products.length === 0) {
                productList.innerHTML = '<div class="status-msg">Belum ada hasil panen yang dijual.</div>';
                return;
            }

            products.forEach(item => {
                // Generate gambar placeholder dinamis
                const imgUrl = `https://picsum.photos/seed/${item.id}/400/200`;
                
                // Status Badge Color
                let statusColor = '#FFA000'; // Orange (Pending)
                let statusText = 'Menunggu';
                if(item.status === 'approved') { statusColor = '#388E3C'; statusText = 'Tersedia'; }
                if(item.status === 'sold') { statusColor = '#1976D2'; statusText = 'Terjual'; }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${imgUrl}" alt="${item.name}" class="card-img">
                    </div>
                    <div class="card-body">
                        <div class="card-category">${item.quality} Quality</div>
                        <h3 class="card-title">${item.name}</h3>
                        <div class="card-meta">
                            <span>üë§ ${item.seller}</span>
                            <span>üì¶ ${item.quantity} ${item.unit}</span>
                        </div>
                        <div class="card-price">Rp ${item.price.toLocaleString('id-ID')} / ${item.unit}</div>
                        <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                            Total Estimasi: <b>Rp ${item.total.toLocaleString('id-ID')}</b>
                        </div>
                        <div class="card-actions">
                            <button class="btn-buy" onclick="buyProduct('${item.name}', '${item.seller}')">
                                Beli Sekarang
                            </button>
                        </div>
                        <div style="margin-top:10px; text-align:center;">
                            <span style="font-size:0.75rem; background:${statusColor}; color:white; padding:2px 8px; border-radius:10px;">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
                productList.appendChild(card);
            });
        }

        // --- 5. LOGIKA FILTER & SEARCH ---
        function filterProducts() {
            const searchVal = searchInput.value.toLowerCase();
            const statusVal = filterStatus.value;

            const filtered = allProducts.filter(item => {
                const matchName = item.name.toLowerCase().includes(searchVal) || item.seller.toLowerCase().includes(searchVal);
                const matchStatus = statusVal === '' || item.status === statusVal;
                return matchName && matchStatus;
            });

            renderGrid(filtered);
        }

        // Event Listeners
        searchInput.addEventListener('input', filterProducts);
        filterStatus.addEventListener('change', filterProducts);

        // --- 6. INTERAKSI BELI ---
        window.buyProduct = function(productName, sellerName) {
            // Simulasi beli
            const confirmBuy = confirm(`Apakah Anda ingin membeli ${productName} dari petani ${sellerName}?`);
            if(confirmBuy) {
                alert("Fitur pembayaran sedang diproses...");
                // Nanti logika insert ke tabel 'orders' di sini
            }
        };

    </script>
</body>
</html>
