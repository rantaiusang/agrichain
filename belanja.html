<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Belanja Panen - AgriChain</title>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-green: #2E7D32;
            --dark-green: #1B5E20;
            --light-green: #E8F5E9;
            --text-dark: #1B1B1B;
            --text-grey: #616161;
            --white: #ffffff;
            --radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f4f6f8;
            color: var(--text-dark);
            margin: 0;
            padding-bottom: 80px; /* Space for bottom bar */
        }

        /* --- HEADER --- */
        .navbar {
            background: var(--white);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary-green);
            text-decoration: none;
        }

        /* --- CONTAINER --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- FILTER SECTION --- */
        .filter-bar {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 2;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }

        /* --- GRID PRODUK --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--white);
            border: 1px solid #eee;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border-color: var(--light-green);
        }

        .card-img-wrapper {
            width: 100%;
            height: 160px;
            overflow: hidden;
            position: relative;
            background: #eee;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-body {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-category {
            font-size: 0.75rem;
            color: var(--text-grey);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .card-meta {
            font-size: 0.85rem;
            color: var(--text-grey);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-price {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-green);
            margin-top: auto; /* Push to bottom */
        }

        .card-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .btn-buy {
            width: 100%;
            padding: 10px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-buy:hover { background-color: var(--dark-green); }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: var(--text-grey);
            text-decoration: none;
            font-weight: bold;
        }
        .back-link:hover { color: var(--primary-green); }

        /* --- LOADING & EMPTY --- */
        .loading-msg {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1rem;
            grid-column: 1 / -1;
        }
        .empty-msg {
            text-align: center;
            padding: 40px;
            color: #999;
            grid-column: 1 / -1;
        }

        /* --- BADGE --- */
        .badge-verified {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .filter-bar { flex-direction: column; align-items: stretch; }
            .search-box { width: 100%; }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <nav class="navbar">
        <a href="index.html" class="nav-brand">AgriChain</a>
        <div>
            <!-- Tombol Profil -->
            <a href="profile.html" style="text-decoration: none; color: #333; font-weight: bold; padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px;">
                üë§ Profil Saya
            </a>
        </div>
    </nav>

    <div class="container">
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Cari komoditas (Padi, Jagung...)">
            </div>
            
            <select id="filterLokasi">
                <option value="">Semua Lokasi</option>
                <!-- Opsi akan diisi JS dari DB -->
            </select>

            <select id="filterType">
                <option value="">Semua Jenis</option>
                <option value="padi">Padi</option>
                <option value="jagung">Jagung</option>
                <option value="kopi">Kopi</option>
                <option value="cabai">Cabai</option>
            </select>
        </div>

        <!-- Grid Produk -->
        <div class="product-grid" id="productList">
            <div class="loading-msg">Memuat produk dari petani...</div>
        </div>

        <div style="text-align: center;">
            <a href="index.html" class="back-link">‚Üê Kembali ke Beranda</a>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://xyzcompany.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. DOM ELEMENTS ---
        const productList = document.getElementById('productList');
        const searchInput = document.getElementById('searchInput');
        const filterLokasi = document.getElementById('filterLokasi');
        const filterType = document.getElementById('filterType');

        let allProducts = []; // Cache semua produk

        // --- 3. LOAD PRODUK & LOKASI ---
        document.addEventListener("DOMContentLoaded", async () => {
            await loadLocations();
            await loadProducts();
        });

        // --- 4. FUNGSI AMBIL LOKASI UNTUK DROPDOWN ---
        async function loadLocations() {
            // Ambil daftar lokasi unik dari tabel produk
            const { data, error } = await supabase
                .from('agrichain_product')
                .select('location');
                .order('location', { ascending: true });

            if (data) {
                // Ambil lokasi unik saja
                const uniqueLocations = [...new Set(data.map(d => d.location))];
                
                // Isi dropdown
                uniqueLocations.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.textContent = loc;
                    filterLokasi.appendChild(opt);
                });
            }
        }

        // --- 5. FUNGSI AMBIL PRODUK ---
        async function loadProducts() {
            // Query produk beserta penjualnya (JOIN MANUAL dengan profiles)
            const { data, error } = await supabase
                .from('agrichain_product')
                .select(`
                    id, name, type, unit, price, location, image_url, created_at,
                    profiles!inner ( full_name, trust_score, avatar_url )
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Gagal load produk:", error);
                productList.innerHTML = '<div class="loading-msg" style="color:red;">Gagal memuat produk.</div>';
                return;
            }

            // Flatten data (karena Supabase join nested data di dalam object)
            // Map data agar mudah diakses
            allProducts = data.map(item => ({
                id: item.id,
                name: item.name,
                type: item.type,
                unit: item.unit,
                price: item.price,
                location: item.location,
                image_url: item.image_url,
                seller_name: item.profiles.full_name,
                trust_score: item.profiles.trust_score,
                avatar_url: item.profiles.avatar_url
            }));

            renderGrid(allProducts);
        }

        // --- 6. RENDER GRID ---
        function renderGrid(products) {
            productList.innerHTML = '';

            if (products.length === 0) {
                productList.innerHTML = '<div class="empty-msg">Tidak ada produk yang sesuai kriteria.</div>';
                return;
            }

            products.forEach(item => {
                // Placeholder image jika kosong
                const imgUrl = item.image_url || `https://picsum.photos/seed/${item.id}/400/200`;
                
                // Format harga
                const priceStr = item.price.toLocaleString('id-ID');

                // Penjual Badge
                const sellerBadge = item.trust_score >= 4.0 ? '<span class="badge-verified">Terpercaya</span>' : '';

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-wrapper">
                        <img src="${imgUrl}" alt="${item.name}" class="card-img">
                    </div>
                    <div class="card-body">
                        <div class="card-category">${item.type}</div>
                        <h3 class="card-title">${item.name}</h3>
                        <div class="card-meta">
                            <span>üìç ${item.location}</span>
                            <span>üë§ ${item.seller_name}</span>
                        </div>
                        <div class="card-price">Rp ${priceStr} / ${item.unit}</div>
                        <div class="card-actions">
                            <button class="btn-buy" onclick="contactSeller('${item.seller_name}', '${item.id}')">Beli / Tanya</button>
                        </div>
                    </div>
                `;
                productList.appendChild(card);
            });
        }

        // --- 7. LOGIKA FILTER ---
        
        function filterData() {
            const searchVal = searchInput.value.toLowerCase();
            const locVal = filterLokasi.value;
            const typeVal = filterType.value;

            // Filter array allProducts
            const filtered = allProducts.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(searchVal) || item.location.toLowerCase().includes(searchVal);
                const matchLoc = locVal === '' || item.location === locVal;
                const matchType = typeVal === '' || item.type.toLowerCase() === typeVal;

                return matchSearch && matchLoc && matchType;
            });

            renderGrid(filtered);
        }

        // --- 8. EVENT LISTENER FILTER ---
        searchInput.addEventListener('input', filterData);
        filterLokasi.addEventListener('change', filterData);
        filterType.addEventListener('change', filterData);

        // --- 9. FUNGSI BELI ---
        window.contactSeller = function(sellerName, productId) {
            alert(`Menghubungi ${sellerName} untuk produk ID: ${productId}...`);
            // Nanti di sini bisa logika redirect ke Chat atau Notif
        };

    </script>
</body>
</html>
