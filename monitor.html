<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring - AgriChain</title>
    
    <!-- Library Supabase & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #2E7D32; 
            --bg: #F1F8E9; 
            --text-color: #333;
            --card-bg: #ffffff;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            padding: 20px; 
            margin: 0;
            color: var(--text-color);
        }
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
        }
        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        h3 { 
            margin-top: 0; 
            color: var(--primary); 
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.1rem;
        }
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            justify-content: center;
            flex-wrap: wrap;
        }
        .tab { 
            padding: 10px 25px; 
            background: #e0e0e0; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease;
            border: none;
            color: #555;
        }
        .tab:hover { background: #d0d0d0; }
        .tab.active { 
            background: var(--primary); 
            color: white; 
            box-shadow: 0 4px 6px rgba(46, 125, 50, 0.3);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        ul { list-style: none; padding: 0; }
        li { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        li:last-child { border-bottom: none; }
        
        .btn-action {
            padding: 8px 16px; 
            background: var(--primary); 
            color: white; 
            border:none; 
            border-radius: 6px; 
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-action:hover { background: #1b5e20; }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: var(--primary);
            font-weight: bold;
            padding: 10px 20px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            transition: all 0.3s;
        }
        .back-link:hover {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: var(--primary); margin: 0; font-size: 2rem;">DASHBOARD MONITORING</h1>
        <p style="color: #666;">Sistem Informasi AgriChain</p>
    </header>

    <!-- Nav Menu -->
    <nav class="tabs">
        <button class="tab active" onclick="openTab(event, 'tabMarket')">üìä Pasar</button>
        <button class="tab" onclick="openTab(event, 'tabAnalisa')">üìâ Analisa Konsumsi</button>
        <button class="tab" onclick="openTab(event, 'tabSmartFarm')">üåæ Smart Farm</button>
    </nav>

    <!-- TAB 1: MARKET (GRAFIK HARGA) -->
    <div id="tabMarket" class="tab-content active">
        <div class="dashboard-grid">
            <!-- GRAFIK 1: PIE CHART (DISTRIBUSI HARGA) -->
            <div class="card">
                <h3>Distribusi Harga Pasar</h3>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Komparasi harga saat ini antar komoditas.</p>
                <div style="height: 250px; position: relative;">
                    <canvas id="chartHargaPadi"></canvas>
                </div>
            </div>
            
            <!-- GRAFIK 2: BAR CHART (TREND) -->
            <div class="card">
                <h3>Tren Harga Minggu Ini</h3>
                <div style="height: 250px; position: relative;">
                    <canvas id="chartKomoditas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: ANALISA KONSUMSI (BAR CHART) -->
    <div id="tabAnalisa" class="tab-content">
        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <h3>Analisa Penggunaan Pupuk</h3>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Data pemakaian pupuk berdasarkan input lahan dan jadwal kegiatan.</p>
            <div style="height: 300px; position: relative;">
                <canvas id="chartKonsumsi"></canvas>
            </div>
        </div>
    </div>

    <!-- TAB 3: SMART FARM (LOG ALERTS) -->
    <div id="tabSmartFarm" class="tab-content">
        <div class="dashboard-grid">
            <div class="card">
                <h3>üìà Log Serangan Hama</h3>
                <ul>
                    <li>
                        <span>üêõ <strong>1 Feb:</strong> Ulat Grayak</span>
                        <span style="color: red; font-weight: bold; background: #ffebee; padding: 2px 8px; border-radius: 4px;">Serius</span>
                    </li>
                    <li>
                        <span>ü¶† <strong>3 Jan:</strong> Kutu Daun</span>
                        <span style="color: orange; font-weight: bold; background: #fff3e0; padding: 2px 8px; border-radius: 4px;">Ringan</span>
                    </li>
                    <li>
                        <span>ü¶† <strong>5 Jan:</strong> Kutu Daun</span>
                        <span style="color: orange; font-weight: bold; background: #fff3e0; padding: 2px 8px; border-radius: 4px;">Ringan</span>
                    </li>
                </ul>
            </div>
            <div class="card">
                <h3>‚òÄÔ∏è Cuaca & Irigasi</h3>
                <div style="background: #E8F5E9; padding: 20px; border-radius: 10px; text-align: center; border: 1px dashed var(--primary);">
                    <div style="font-size: 2.5rem;">‚òÄÔ∏è</div>
                    <p style="margin: 10px 0;"><strong>Status Cuaca:</strong> Panas Terik (32¬∞C)</p>
                    <p style="margin-bottom: 20px;"><strong>Saran:</strong> Siram sore hari ini (16:00).</p>
                    <button class="btn-action" onclick="alert('Jadwal otomatis diatur!')">Atur Otomatis</button>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align: center;">
        <a href="index.html" class="back-link">‚Üê Kembali ke Beranda</a>
    </div>

    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://xyzcompany.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let marketData = [];

        // --- 2. LOAD DATA ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Cek Login (Opsional)
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                // Jika ingin paksa login:
                // window.location.href = 'login.html'; 
                console.log("User belum login, tapi data monitoring publik.");
            }

            // Load Harga Pasar
            const { data, error } = await supabase
                .from('market_prices')
                .select('*')
                .order('current_price', { ascending: false });

            if (data) {
                marketData = data;
                renderCharts();
            } else {
                console.error("Gagal load data:", error);
            }
        });

        // --- 3. RENDER CHARTS ---
        function renderCharts() {
            // Siapkan Data untuk Chart.js
            const labels = marketData.map(d => d.commodity_name);
            const prices = marketData.map(d => d.current_price);

            // A. CHART 1: PIE CHART (Distribusi Harga)
            // Pie Chart bagus untuk melihat proporsi harga komoditas terhadap total nilai pasar
            const ctxPadi = document.getElementById('chartHargaPadi');
            new Chart(ctxPadi, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Harga (Rp)',
                        data: prices,
                        backgroundColor: [
                            '#2E7D32', // Hijau
                            '#FFA000', // Oranye
                            '#43A047', 
                            '#66BB6A', 
                            '#81C784', 
                            '#A5D6A7', 
                            '#C8E6C9'
                        ],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } }
                    }
                }
            });

            // B. CHART 2: BAR CHART (Perbandingan Langsung)
            const ctxKomoditas = document.getElementById('chartKomoditas');
            new Chart(ctxKomoditas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Harga Saat Ini (Rp/Kg)',
                        data: prices,
                        backgroundColor: 'rgba(46, 125, 50, 0.7)',
                        borderColor: 'rgba(46, 125, 50, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: function(value) { return 'Rp ' + value/1000 + 'rb'; } } }
                    }
                }
            });

            // C. CHART 3: ANALISA KONSUMSI (Simulasi Data Sementara)
            // Untuk chart ini, karena belum ada tabel 'pupuk_usage', kita pakai dummy data
            const ctxKonsumsi = document.getElementById('chartKonsumsi');
            new Chart(ctxKonsumsi, {
                type: 'bar',
                data: {
                    labels: ['Pupuk Urea', 'Pupuk NPK', 'Pupuk Organik'],
                    datasets: [{
                        label: 'Penggunaan (Kg)',
                        data: [500, 300, 100],
                        backgroundColor: ['#FFC107', '#FF9800', '#4CAF50'],
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    scales: { x: { beginAtZero: true } },
                    responsive: true, 
                    maintainAspectRatio: false
                }
            });
        }

        // --- 4. FUNGSI TAB UI ---
        function openTab(evt, tabName) {
            var i, tabcontent, tabs;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tabs = document.getElementsByClassName("tab");
            for (i = 0; i < tabs.length; i++) {
                tabs[i].className = tabs[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            // Sedikit delay agar animasi CSS berjalan
            setTimeout(() => {
                document.getElementById(tabName).classList.add("active");
            }, 10);
            evt.currentTarget.className += " active";
        }

    </script>
</body>
</html>
