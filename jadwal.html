<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal & Kegiatan - AgriChain</title>
    
    <!-- Library Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-green: #2E7D32;
            --light-green: #E8F5E9;
            --dark-green: #1B5E20;
            --text-dark: #333;
            --white: #ffffff;
            --shadow: 0 2px 5px rgba(0,0,0,0.05);
            --radius: 8px;
        }

        body {
            font-family: "Segoe UI", Roboto, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        h2 { color: var(--primary-green); margin-top: 0; }
        h3 { margin-bottom: 15px; color: var(--text-dark); }
        
        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom:5px; font-weight: 600; color: var(--text-dark); }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        .btn-primary {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-secondary {
            background: #eee;
            color: #333;
            border: 1px solid #ccc;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
        .btn-danger {
            background: #D32F2F;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th { background: var(--light-green); color: var(--primary-green); font-weight: 600; }
        
        /* Status Badge */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .status-upcoming { background: #FFF3E0; color: #F57F17; }
        .status-done { background: #E8F5E9; color: #2E7D32; }

        /* Alert */
        .alert {
            padding: 15px;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: none;
        }

        /* Header Nav */
        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .back-link { color: var(--primary-green); text-decoration: none; font-weight: bold; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-nav">
            <h2>üóìÔ∏è Jadwal Pertanian</h2>
            <a href="index.html" class="back-link">Kembali ke Beranda</a>
        </div>

        <!-- Form Input Jadwal -->
        <div class="card">
            <h3>Input Kegiatan Baru</h3>
            <div id="alertBox" class="alert"></div>
            <form id="jadwalForm">
                <div class="form-group">
                    <label for="kegiatan">Nama Kegiatan</label>
                    <input type="text" id="kegiatan" placeholder="Contoh: Tanam Padi, Panen Jagung" required>
                </div>
                <div class="form-group">
                    <label for="tanggal">Tanggal & Waktu</label>
                    <input type="datetime-local" id="tanggal" required>
                </div>
                <div class="form-group">
                    <label for="catatan">Catatan / Detail</label>
                    <textarea id="catatan" rows="3" placeholder="Contoh: Siapkan bibit dan pupuk..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn-primary">Simpan Jadwal</button>
                </div>
            </form>
        </div>

        <!-- Tabel Daftar Jadwal -->
        <div class="card">
            <h3>Daftar Kegiatan Saya</h3>
            <table>
                <thead>
                    <tr>
                        <th>Kegiatan</th>
                        <th>Tanggal</th>
                        <th>Waktu</th>
                        <th>Status</th>
                        <th>Catatan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="jadwalBody">
                    <!-- Data akan dirender lewat JS -->
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999;">Memuat jadwal...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div id="toast" class="toast">Data disimpan</div>

    <!-- Script Utama -->
    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://xyzcompany.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUserId = null;

        // --- 2. DOM ELEMENTS ---
        const formJadwal = document.getElementById('jadwalForm');
        const jadwalBody = document.getElementById('jadwalBody');
        const alertBox = document.getElementById('alertBox');
        const toast = document.getElementById('toast');

        // --- 3. LOAD JADWAL DARI DATABASE ---
        async function loadSchedules() {
            jadwalBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Memuat jadwal...</td></tr>';
            
            const { data, error } = await supabase
                .from('farmer_schedules')
                .select('*')
                .order('schedule_date', { ascending: true }); // Urutkan terdekat dulu

            if (error) {
                console.error(error);
                jadwalBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Gagal memuat jadwal.</td></tr>';
                return;
            }

            renderTable(data);
        }

        // --- 4. RENDER TABEL ---
        function renderTable(schedules) {
            jadwalBody.innerHTML = '';

            if (schedules.length === 0) {
                jadwalBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Belum ada jadwal.</td></tr>';
                return;
            }

            schedules.forEach(item => {
                const dateObj = new Date(item.schedule_date);
                // Format Tanggal Indonesia
                const tglIndo = dateObj.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const jamIndo = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                
                // Cek Status (Selesai atau Akan Datang)
                const isUpcoming = new Date(item.schedule_date) > new Date();
                const statusBadge = isUpcoming 
                    ? '<span class="status-badge status-upcoming">Akan Datang</span>' 
                    : '<span class="status-badge status-done">Selesai</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.activity_name}</strong></td>
                    <td>${tglIndo}</td>
                    <td>${jamIndo}</td>
                    <td>${statusBadge}</td>
                    <td style="font-size: 0.9rem; color: #666;">${item.notes}</td>
                    <td><button class="btn-danger" onclick="hapusJadwal(${item.id})">Hapus</button></td>
                `;
                jadwalBody.appendChild(row);
            });
        }

        // --- 5. HANDLE SUBMIT FORM ---
        formJadwal.addEventListener('submit', async function(e) {
            e.preventDefault();

            const kegiatan = document.getElementById('kegiatan').value;
            const tanggal = document.getElementById('tanggal').value;
            const catatan = document.getElementById('catatan').value;

            // UI Loading
            const btnSubmit = formJadwal.querySelector('button[type="submit"]');
            const originalText = btnSubmit.textContent;
            btnSubmit.textContent = "Menyimpan...";
            btnSubmit.disabled = true;

            try {
                const { error } = await supabase
                    .from('farmer_schedules')
                    .insert([{
                        user_id: currentUserId,
                        activity_name: kegiatan,
                        schedule_date: tanggal, // datetime-local input format ISO, cocok dengan timestamp with time zone
                        notes: catatan
                    }]);

                if (error) throw error;

                showToast("Jadwal berhasil ditambahkan!");
                resetForm();
                loadSchedules(); // Refresh tabel

            } catch (err) {
                console.error(err);
                alert("Gagal menyimpan: " + err.message);
            } finally {
                btnSubmit.textContent = originalText;
                btnSubmit.disabled = false;
            }
        });

        // --- 6. HANDLE HAPUS ---
        window.hapusJadwal = async function(id) {
            const confirmDel = confirm("Hapus jadwal ini?");
            if (confirmDel) {
                const { error } = await supabase
                    .from('farmer_schedules')
                    .delete()
                    .eq('id', id);

                if (error) {
                    alert("Gagal menghapus: " + error.message);
                } else {
                    loadSchedules(); // Refresh tabel
                }
            }
        };

        // --- 7. HELPER FUNCTIONS ---
        function resetForm() {
            formJadwal.reset();
        }

        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // --- 8. INISIALISASI ---
        document.addEventListener("DOMContentLoaded", async () => {
            // Cek Login
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUserId = session.user.id;

            // Load Data
            await loadSchedules();

            // Cek Jadwal Terdekat & Beri Notifikasi Sederhana
            const now = new Date();
            const upcomingSchedules = (await supabase
                .from('farmer_schedules')
                .select('activity_name, schedule_date')
                .gte('schedule_date', now.toISOString())
                .order('schedule_date', { ascending: true })
                .limit(1)
            ).data || [];

            if (upcomingSchedules.length > 0) {
                const next = upcomingSchedules[0];
                const dateObj = new Date(next.schedule_date);
                const tglIndo = dateObj.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                const jamIndo = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                
                // Tampilkan Alert Custom atau Toast
                setTimeout(() => {
                    alert(`üóìÔ∏è PENGINGAT JADWAL!\n\nKegiatan: ${next.activity_name}\nWaktu: ${tglIndo}, Pukul ${jamIndo}`);
                }, 1000);
            }
        });

    </script>
</body>
</html>
