<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgriChain</title>
<link rel="stylesheet" href="../style.css">
</head>
<body>

<header>
    <h1>AgriChain - Pasar Pertanian</h1>
    <button id="btnChat">ðŸ’¬ Tanya Ahli</button>
    <button id="btnWallet">Dompet</button>
</header>

<main>
    <section class="market-section">
        <h2>Panen Siap Jual</h2>
        <div id="productList">
            <div style="text-align:center; color:#999;">Memuat data pasar...</div>
        </div>
    </section>

    <div id="chatContainer" style="display:none;">
        <div id="chatBox"></div>
        <input id="chatInput" placeholder="Tanya...">
        <button onclick="sendChat()">Kirim</button>
    </div>
</main>

<script type="module">
import { getProducts } from '../src/api.js';
import { handleChat, getChatHistory, renderChatUI } from '../src/appchat.js';
import { connectWallet } from '../src/connectWallet.js';

const productList = document.getElementById('productList');
const chatContainer = document.getElementById('chatContainer');
const chatInput = document.getElementById('chatInput');
const btnChat = document.getElementById('btnChat');
const btnWallet = document.getElementById('btnWallet');

// Render products
document.addEventListener("DOMContentLoaded", async () => {
    const products = await getProducts();
    productList.innerHTML = '';
    if(products.length === 0) {
        productList.innerHTML = '<div style="text-align:center;">Belum ada data panen.</div>';
    } else {
        products.forEach(p => {
            const card = document.createElement('div');
            card.textContent = ${p.name} - Rp ${p.price};
            productList.appendChild(card);
        });
    }

    // Load chat
    renderChatUI(getChatHistory());
});

// Chat toggle
btnChat.onclick = () => {
    chatContainer.style.display = chatContainer.style.display === 'none' ? 'block' : 'none';
}

// Send chat
window.sendChat = () => {
    const q = chatInput.value;
    if(!q.trim()) return;
    handleChat(q);
    chatInput.value = '';
}

// Wallet
btnWallet.onclick = async () => {
    const res = await connectWallet();
    if(res.success) btnWallet.textContent = res.address;
}
</script>

</body>
</html>
